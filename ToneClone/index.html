<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="ProgId" content="Word.Document">
<meta name="Generator" content="Microsoft Word 11">
<meta name="Originator" content="Microsoft Word 11">
<link rel="File-List" href="./index_files/filelist.xml">
<link rel="Edit-Time-Data" href="./index_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title align="CENTER">The IC-901 ToneUnit Page</title>
<meta name="description" content="Circuit theory, software theory of operation, assembly, and operation of the IC-901 Tone Unit designed by Joe Haas, KE0FF.">
<meta name="keywords" content="ICOM,CTCSS,Continuous Tone Coded Squelch,Private Line,FM,Repeater Control,C8051F530">
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>J</o:Author>
  <o:LastAuthor>J</o:LastAuthor>
  <o:Revision>7</o:Revision>
  <o:TotalTime>5</o:TotalTime>
  <o:Created>2012-12-20T18:22:00Z</o:Created>
  <o:LastSaved>2012-12-20T22:32:00Z</o:LastSaved>
  <o:Pages>2</o:Pages>
  <o:Words>475</o:Words>
  <o:Characters>2714</o:Characters>
  <o:Company> DACINT</o:Company>
  <o:Lines>22</o:Lines>
  <o:Paragraphs>6</o:Paragraphs>
  <o:CharactersWithSpaces>3183</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:14.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h2
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:14.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:14.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:1021979350;
	mso-list-template-ids:450297508;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	mso-ansi-font-size:14.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--></head><body bgcolor="white" background="../index_files/ffback.JPG" lang="EN-US" link="blue" vlink="blue" style="tab-interval:.5in"><header></header><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="5122"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->




<div class="Section1">

<div class="MsoNormal" align="center" style="text-align:center">

<hr size="2" width="100%" align="center">

</div>

<div class="MsoNormal" align="center" >

<h2 align="center" style="text-align:center">IC-901 Tone Unit Clone Project Page</h2>

<p class="MsoNormal">Updated 05/20/2021 </p>
<a href="../index.html">(Back to the Projects page...)</a>

<hr size="2" width="100%" align="center">

</div>

<!--<p class="MsoNormal" align="center" style="text-align:center"><img width="483" height="839" id="_x0000_i1026" src="./ToneUnit_banner.jpg"> -->
<center>
<table border="0" width="1000">
<tr>
<td>
<img width="513" height="499" id="_x0000_i1026" src="./ToneUnit_banner.jpg">
</td>
<td>
<img width="40" height="20" id="_x0000_i1026" src="./space40.png">
</td>
<td>
<center>

This is a clone of the ICOM IC-901 CTCSS encoder board to allow the drop-in, form, fit, and function replacement of a lost or damaged encoder board.</p>

A small microcontroller is used to capture digital information from the IC-901 as clocked serial data and use
the captured data to generate the desired CTCSS tone.</p>

While software skills and tools are not required, the Software link below provides instructions 
to obtain the source code for this (relatively simple) project.  Links to the tools needed to compile and program 
the <a href="http://www.silabs.com">SiLabs</a> C8051F530 microcontroller used for this project are provided below.</p>
<font size = "5">
<a href = "index.html#synopsys">"Intro"</a></p>
<a href = "index.html#hw">"Hardware design"</a></p>
<a href = "index.html#sw">"Software design"</a></p>
<a href = "index.html#summary">"Summary"</a></p>
</td>
</tr>
</table>
</center>


<div class="MsoNormal" align="center" style="text-align:center">

<hr size="2" width="100%" align="center">

</div>
<center>
<h2>A Brief Synopsis... <a name = "synopsys"></a></h2>
<table border="0" width="900">
<tr>
</center>
<td>
<font size = "4">
This project was born of necessity when an IC-901 that I purchased arrived with no encode board.  Since these boards were not options (they were included with all the radios sold, as far as I'm aware)
there aren't really any floating around on the open market.  Hence the need to re-create the functionality. This web page details the hardware and software design for this project. 
</p>
</td>
</tr>
</table>
<hr size="2" width="100%" align="center">

</div>
<center>
<h2>Hardware Design... <a name = "hw"></a></h2>
<table border="0" width="900">
<tr>
</center>
<td>
<font size = "4">

I was hoping to use an Atmel ATtiny-3217 for this project, but I found that the options for generating a precision clock that the MCU's timer system could use were very limited.
This led me back to my trusty C8051F530.  The tone generator was copied from the HM-133 project, so more time ended up spent on removing code rather than adding.
</p>
The hardware is pretty simple.  There is a crystal and a couple of loading caps and a bootstrap resistor to create the frequency reference.  Some filtering is needed for the DDS PWM-DAC,
a pot for level adjustment, and a connector to mate with the IC-901 connector.  Edge interrupts were to be used to capture the serial clock and strobe signals so this constrained the
selection of the I/O pins for these signals. The PWM-DAC is the same as for the HM-133, and this also constrained the selection of I/O.
</p>
Once the I/O pins were assigned, a couple of poles of RC filtering were added along with the same level circuit as used on the ICOM verion of the board.  With the help of a S.C.A.B. board
and a small square of bare PCB material, I was able to hand-wire a prototype.  To save space, I wired an external programming connector with the intention that it would be de-soldered and
removed once the programming and debug were concluded.
</p>
<center>
<a href="TonePgm.jpg"><img width="373" height="328" id="_x0000_i1026" src="./TonePgm.jpg"></a>

<h3>Tone Unit Clone with PGM cable attached</h3>
<h5>(click on image to see a larger version)</h5>
<center>

</td>
</tr>
</table>
<center>
<a href="ToneUnit.pdf"><img width="695" height="521" src="./ToneUnitsch_thmb.jpg"></a>
</p>
<h3>IC-901 Tone Unit Clone Schematic and Parts List</h3>
<h5>(click on image to see a pdf version)</h5>
</center>
<hr size="2" width="100%" align="center">

</div>
<center>
<h2>Software Design... <a name = "sw"></a></h2>
<table border="0" width="900">
<tr>
</center>
<td>
<font size = "4">

The software operates completely using interrupts.  The main loop is empty except for an instruction to place the MCU into a "wait-for-interrupt" state.  
</p> 
There is one timer interrupt, and one Programmable Counter/timer Array (PCA) interrupt.  The timer interrupt (Timer 1) handles the code to process the DDS tone generator.
The PCA captures SCLK and STB edges and parses them into an 8-bit result which contains bit-mapped information on tone frequency and tone on/off status.
</p>
Timer 1 implements a simple, 1-tone DDS generator that is phase-accumulator based (see <a href="https://www.nxp.com/docs/en/application-note/AN1771.pdf">NXP's AN1771</a> for a detailed treatise
on the subject).  For the DAC, one of the PCA PWMs is used, but not as an interrupt.  The idea is that since timer 1 and the PCA run off of the same clock base, they will remain synchronized.
This allows the DDS algorithm running in Timer 1 to write updates to the PWM without worrying about pop-noise that can occur if the update isn’t precisely aligned to the DDS sample clock.
</p>
The PCA interrupt is the most complicated ISR in this project.  It captures serial clock and strobe edges along with the data signal and then parses them into 1’s or 0’s which are shifted
into the result register. The strobe edge detect parses the data received and updates the tone frequency or turns off the tone based on the bit pattern in the data register. 
This part of the code essentially emulates a CD4094 shift register IC which is what is used on the original Tone Unit to capture the data message.
</p>
The main application initializes the GPIO and peripherals, and then enters the main process loop (MPL) which, as noted, is simply a write to an MCU register to place the MCU into an
"idle" state until an interrupt occurs.
</p>
Measurements using a toggle function at an un-used I/O pin indicate that the ISRs occupy approximately 1/5 of the available processor time.  Running at the colorburst * 4 frequency would give
more headroom, but this isn't likely needed for the purposes of gaining more processor cycles.
</p>
I did not manage to conjur a bug-free application on the first pass.  I ended up with a couple of bugs that were minor, but one took a bit of hair-pulling to locate.  The first bug found was
in the shift code.  I shifted the data in the wrong direction (D'OH!!!).  The second bug was a cut-n-paste error and was the hardest to find.  The pasted line was edited except for the type cast, which
left it with the wrong data size for an extern reference.  No error or warning resulted, but the code didn't work right. Close, but no cigar. Overall, it came together rather well and does
what it needs to do.
</p>
DPL is an option I'm considering.  I need to review the specs for the data sequencing.  The main problem lies in how to configure the DPL tone selection.  The IC-901 only sends 38 unique
codes to the Tone Unit.  These currently align with particular CTCSS frequencies. The 901 just doesn't have any provisions for any other codes.  The solution would be to re-assign some of the
CTCSS codes to DPL.  The idea would be to choose codes that correspond to CTCSS frequencies that are rare, or at least, rare for one's area.  For me, I'd choose the top 5 or 6 codes as I
have not seen any of those used before.  The 901 will still display the CTCSS frequency for these codes, so the operator will just have to "know" which one is which.
</p>
The object code for the Tone Unit is available on my <a href="https://github.com/ke0ff">github repo</a>.  The <i><a href="../Orion/silabspgm.pdf">"SiLabs Programming guide"</a></i> describes 
the hardware and steps needed to program the project MCU.  
</p>

</td>
</tr>
</table>
<hr size="2" width="100%" align="center">

</div>
<center>
<hr size="2" width="100%" align="center">

<center>
<h2>Summary... <a name = "summary"></a></h2>
</p>
<table border="0" width="900">
<tr>
</center>

<td>
<font size = "4">
The clone is slightly larger than the original, but this could be easily addressed with a PCB layout. Total time on this project was just a few days and the result is exactly what was needed. 
</p>
<center>
<a href="Clone_vs_Original.jpg"><img width="560" height="278" src="./Clone_vs_Original.jpg"></a>
</p>
<h3>Comparison of the stock IC-901 Tone Unit and the new ToneClone </h3>
</center>
<br>
Here is a listing of the various project documents that are directly relevant to the DTMF Adapter:
</p>
</td>
</tr>
</table>

<table border="0" width="500">
<tr>

<td>
<font size = "4">
<a href="../Orion/silabspgm.pdf">SiLabs Programming guide</a> </p>
<a href="ToneUnit.pdf">IC-901 Tone Unit Clone Schematic</a> </p>
<a href="https://github.com/ke0ff/IC901_ToneUnit_clone">ToneClone github repo</a> </p>
</td>
</tr>
</table>
</p>
<hr size="2" width="100%" align="center">

<hr size="2" width="100%" align="center">
</div>


</center>

<p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><o:p>&nbsp;</o:p></p>

</div>




</body></html>
